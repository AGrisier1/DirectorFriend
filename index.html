<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>The Director's Friend â€” Wallet Cards</title>
  <meta name="theme-color" content="#0b2545">
  <link rel="manifest" href="manifest.json">
  <style>
    :root{ --navy:#0b2545; --ink:#0f172a; --muted:#475569; --card:#ffffff; }
    *{ box-sizing:border-box; }
    html,body{ margin:0; background:var(--navy); font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; color:var(--ink); height:100%; }
    header{ position:sticky; top:0; background:var(--navy); color:#fff; padding:14px 16px; border-bottom:1px solid rgba(255,255,255,.15); z-index:100; }
    header h1{ margin:0; font-size:18px; }
    main{ max-width:860px; margin:0 auto; padding:16px; min-height: calc(100vh - 58px); }
    .stack-wrap{ position:relative; height: calc(100vh - 120px); overflow-y:auto; padding-right:4px; }
    .stack{ position:relative; perspective:1000px; padding-bottom:40px; }
    .toolbar{ display:flex; gap:8px; align-items:center; color:#e7e9ee; font-size:12px; margin-bottom:8px; flex-wrap:wrap; }
    .btn{ background:var(--navy); color:#fff; border:0; border-radius:10px; padding:8px 12px; font-size:14px; cursor:pointer; }
    .btn.secondary{ background:#0f172a; }
    .input, .select, .dt{ width:100%; border:1px solid #cbd5e1; background:#fff; border-radius:10px; padding:6px 8px; font-size:14px; }
    .card{ background:var(--card); border-radius:22px; box-shadow:0 10px 28px rgba(0,0,0,.25); padding:16px; margin:0 auto; width:100%;
           transform: translateY(var(--offset,0px)) rotateX(var(--tilt,0deg)); transform-origin: top center;
           transition: transform .18s ease, box-shadow .18s ease; border:1px solid #e5e7eb; }
    .card + .card{ margin-top:-84px; }
    .card.collapsed:hover{ cursor:pointer; }
    .card.expanded{ z-index:9; transform: translateY(0) rotateX(0); box-shadow:0 12px 34px rgba(0,0,0,.35); margin-top:16px; }
    .collapsed .expandable{ display:none; }
    .collapsed .header-only{ display:flex; align-items:center; }
    .expanded .header-only{ display:none; }
    .expanded .expandable{ display:block; }
    .name-big{ font-size:26px; font-weight:800; letter-spacing:.2px; color:#0f172a; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .subline{ color:#64748b; font-size:12px; margin-top:2px; }
    .row{ display:flex; align-items:center; gap:10px; }
    .right{ margin-left:auto; }
    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .section{ background:#fafafa; border:1px solid #ececec; border-radius:14px; padding:12px; }
    .section h3{ margin:0 0 8px 0; font-size:13px; text-transform:uppercase; letter-spacing:.05em; color:#334155; }
    .kv{ display:grid; grid-template-columns: 140px 1fr; gap:6px; font-size:14px; }
    .kv div{ padding:2px 0; }
    .kv label{ font-size:12px; color:#475569; }
    .checklist li{ list-style:none; margin:6px 0; display:flex; align-items:center; gap:8px; font-size:14px; }
    .tick{ width:16px; height:16px; border:1px solid #cbd5e1; border-radius:4px; display:inline-flex; align-items:center; justify-content:center; }
    .tick.done{ background:#0ea5e9; color:#fff; border-color:#0ea5e9; }
    .toast{ position:fixed; bottom:16px; left:50%; transform:translateX(-50%); background:#0f172a; color:#fff; padding:8px 12px; border-radius:10px; font-size:12px; opacity:0; transition:opacity .2s ease; }
    .toast.show{ opacity:1; }
    .login{ max-width:420px; margin:48px auto; background:#fff; border-radius:16px; padding:16px; box-shadow:0 8px 24px rgba(0,0,0,.25); }
    .muted{ color:#64748b; font-size:12px; }
    @media print { header, body{ background:#fff; } main{ height:auto; } .card{ margin:16px 0 !important; box-shadow:none !important; } .card + .card{ margin-top:16px; } }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<header><h1>Active Cases â€” Wallet Stack</h1></header>
<main id="app"></main>
<div id="toast" class="toast">Saved</div>

<script>
// ðŸ”§ Replace with your Supabase details if different
const SUPABASE_URL = "https://rmumlvpoljhqvgmxijzf.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJtdW1sdnBvbGpocXZnbXhpanpmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ3NjM2ODgsImV4cCI6MjA3MDMzOTY4OH0.8UekgrJ4kTZ-DeOMhKSMxfRFj4qHWYsph7AgQmYV-eY";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

const app = document.getElementById('app');
const toast = document.getElementById('toast');
let INITIALS = localStorage.getItem('df_initials') || '';

// Boot
init();

async function init(){
  const passHash = await getSharedPassHash();
  if (!passHash) { renderSetPassword(); return; }
  renderLogin();
}

function showToast(){ toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'), 700); }

function sha256(str){
  const enc = new TextEncoder().encode(str);
  return crypto.subtle.digest('SHA-256', enc).then(buf=> Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join(''));
}

async function getSharedPassHash(){
  const { data, error } = await sb.from('settings').select('value').eq('key','shared_pass_hash').maybeSingle();
  if (error) return null;
  return data?.value || null;
}

async function setSharedPassHash(hash){
  await sb.from('settings').upsert({ key:'shared_pass_hash', value: hash });
}

function renderSetPassword(){
  app.innerHTML = `
    <div class="login">
      <h2 style="margin:0 0 8px 0">Set Shared Password</h2>
      <div class="muted">This protects the app. You'll share this password with your staff.</div>
      <div style="margin-top:12px">
        <label class="muted">New Password</label>
        <input id="p1" class="input" type="password" placeholder="Choose a password">
      </div>
      <div style="margin-top:8px">
        <label class="muted">Confirm Password</label>
        <input id="p2" class="input" type="password" placeholder="Retype password">
      </div>
      <div style="margin-top:12px; display:flex; gap:8px">
        <button class="btn" id="savepass">Save Password</button>
      </div>
    </div>`;
  document.getElementById('savepass').onclick = async () => {
    const p1 = document.getElementById('p1').value.trim();
    const p2 = document.getElementById('p2').value.trim();
    if (!p1 || p1!==p2) { alert('Passwords do not match.'); return; }
    const hash = await sha256(p1);
    await setSharedPassHash(hash);
    alert('Password set. Next, log in.');
    renderLogin();
  };
}

function renderLogin(){
  app.innerHTML = `
    <div class="login">
      <h2 style="margin:0 0 8px 0">Sign In</h2>
      <div class="muted">Enter your initials and the shared password.</div>
      <div style="margin-top:12px">
        <label class="muted">Initials</label>
        <input id="initials" class="input" placeholder="e.g., AG" value="${INITIALS}">
      </div>
      <div style="margin-top:8px">
        <label class="muted">Shared Password</label>
        <input id="pass" class="input" type="password" placeholder="Enter password">
      </div>
      <div style="margin-top:12px; display:flex; gap:8px">
        <button class="btn" id="loginbtn">Log In</button>
      </div>
    </div>`;
  document.getElementById('loginbtn').onclick = doLogin;
}

async function doLogin(){
  const initials = document.getElementById('initials').value.trim().toUpperCase();
  const pass = document.getElementById('pass').value.trim();
  if (!initials || !pass) return alert('Enter initials and password.');
  const stored = await getSharedPassHash();
  const hash = await sha256(pass);
  if (hash !== stored) return alert('Wrong password.');
  INITIALS = initials; localStorage.setItem('df_initials', INITIALS);
  renderApp();
}

async function renderApp(){
  app.innerHTML = `
    <div class="toolbar">
      <button class="btn" id="newcase">New Case</button>
      <button class="btn secondary" id="refresh">Refresh</button>
      <span class="muted">Logged in as <b>${INITIALS}</b></span>
    </div>
    <div class="stack-wrap"><div class="stack" id="stack"></div></div>`;
  document.getElementById('refresh').onclick = renderApp;
  document.getElementById('newcase').onclick = () => openNewCaseForm();
  await loadAndRenderCases();
  if ('serviceWorker' in navigator) { navigator.serviceWorker.register('./sw.js'); }
}

async function loadAndRenderCases(){
  const { data, error } = await sb.from('cases').select('*').neq('status','completed').order('created_at',{ ascending:false });
  if (error) { app.querySelector('#stack').innerHTML = '<div class="muted">Error loading.</div>'; return; }
  const stack = document.getElementById('stack');
  stack.innerHTML='';
  data.forEach((kase, i) => {
    const card = document.createElement('section');
    card.className = 'card collapsed';
    card.style.setProperty('--offset', (i*64)+'px');
    card.style.setProperty('--tilt', (i*0.12)+'deg');
    card.innerHTML = cardHtml(kase);
    card.addEventListener('click', (e) => {
      const t = e.target;
      if(t.closest('.btn') || t.closest('input') || t.closest('select') || t.closest('textarea') || t.closest('label')) return;
      const expanded = card.classList.contains('expanded');
      document.querySelectorAll('.card').forEach(c => c.classList.remove('expanded'));
      if(!expanded) card.classList.add('expanded');
      card.scrollIntoView({ behavior:'smooth', block:'start' });
    });
    stack.appendChild(card);

    // Buttons
    card.querySelector('.btn.export').addEventListener('click', (e)=>{ e.stopPropagation(); openPrintView(kase); });
    card.querySelector('.btn.collapse').addEventListener('click', (e)=>{ e.stopPropagation(); card.classList.remove('expanded'); });
    card.querySelector('.btn.complete').addEventListener('click', async (e)=>{
      e.stopPropagation();
      openPrintView(kase);
      await updateCase(kase.id, { status:'completed' });
      await loadAndRenderCases();
    });

    // Inputs
    card.querySelectorAll('[data-bind]').forEach(el => {
      const path = el.getAttribute('data-bind');
      setInputFromPath(el, kase, path);
      el.addEventListener('input', (e)=>{ onFieldChange(kase, path, el); });
      el.addEventListener('change', (e)=>{ onFieldChange(kase, path, el); });
    });
  });
}

function onFieldChange(kase, path, el){
  const val = (el.type==='checkbox')? el.checked : (el.type==='datetime-local'? new Date(el.value).toISOString() : el.value);
  const patch = makePatch(path, val);
  updateCase(kase.id, patch).then(()=> showToast());
}

async function updateCase(id, patch){
  patch.updated_at = new Date().toISOString();
  const { error } = await sb.from('cases').update(patch).eq('id', id);
  if (error) alert('Save failed: ' + error.message);
}

function makePatch(path, value){
  const map = {
    'visitation.when':'visitation_when',
    'visitation.where':'visitation_where',
    'visitation.note':'visitation_note',
    'service.when':'service_when',
    'service.where':'service_where',
    'service.type':'service_type',
    'service.note':'service_note',
    'cemetery':'cemetery',
    'vault':'vault',
    'hearse':'hearse',
    'clergy':'clergy',
    'casket':'casket',
    'gather':'gather',
    'notes':'notes',
    'obituary':'obituary',
    'veteran':'veteran',
    'dc_created':'dc_created',
    'dc_signed':'dc_signed',
    'dc_filed':'dc_filed',
    'flag':'flag',
    'yellow_sheet':'yellow_sheet',
    'print_goods':'print_goods',
    'fingerprints':'fingerprints',
    'photo':'photo',
    'decedent_name':'decedent_name',
    'case_no':'case_no',
    'fdic':'fdic',
    'location':'location'
  };
  const col = map[path]; const out={}; out[col]=value; return out;
}

function setInputFromPath(el, kase, path){
  const map = {
    'visitation.when':'visitation_when',
    'visitation.where':'visitation_where',
    'visitation.note':'visitation_note',
    'service.when':'service_when',
    'service.where':'service_where',
    'service.type':'service_type',
    'service.note':'service_note',
    'cemetery':'cemetery',
    'vault':'vault',
    'hearse':'hearse',
    'clergy':'clergy',
    'casket':'casket',
    'gather':'gather',
    'notes':'notes',
    'obituary':'obituary',
    'veteran':'veteran',
    'dc_created':'dc_created',
    'dc_signed':'dc_signed',
    'dc_filed':'dc_filed',
    'flag':'flag',
    'yellow_sheet':'yellow_sheet',
    'print_goods':'print_goods',
    'fingerprints':'fingerprints',
    'photo':'photo',
    'decedent_name':'decedent_name',
    'case_no':'case_no',
    'fdic':'fdic',
    'location':'location'
  };
  const col = map[path];
  const val = kase[col];
  if (el.type==='checkbox') el.checked = !!val;
  else if (el.type==='datetime-local') el.value = toLocalInput(val);
  else el.value = val || '';
}

function toLocalInput(iso){
  if(!iso) return '';
  const d=new Date(iso);
  const pad=n=>String(n).padStart(2,'0');
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
}

function cardHtml(k){
  return `
    <div class="header-only" style="min-height:68px">
      <div class="row" style="width:100%">
        <div>
          <div class="name-big"><input class="input" data-bind="decedent_name" placeholder="Name" style="font-weight:800; font-size:26px; width:260px"></div>
          <div class="subline">Case # <input class="input" data-bind="case_no" style="width:110px; display:inline-block"> Â· 
            <input class="input" data-bind="location" style="width:110px; display:inline-block"> Â· 
            FDIC <input class="input" data-bind="fdic" style="width:70px; display:inline-block">
          </div>
        </div>
        <div class="right" style="color:#64748b;font-size:12px">Tap to expand</div>
      </div>
    </div>

    <div class="expandable">
      <div class="row" style="flex-wrap:wrap; gap:8px 12px">
        <div>
          <div style="font-size:22px;font-weight:800"><input class="input" data-bind="decedent_name" placeholder="Name" style="font-weight:800; font-size:22px; width:260px"></div>
          <div class="subline">Case # <input class="input" data-bind="case_no" style="width:120px; display:inline-block"> Â· 
            <input class="input" data-bind="location" style="width:120px; display:inline-block"> Â· 
            FDIC <input class="input" data-bind="fdic" style="width:80px; display:inline-block">
          </div>
        </div>
        <div class="right" style="display:flex; gap:8px; flex-wrap:wrap">
          <button class="btn export">Export PDF</button>
          <button class="btn secondary complete">Case Complete</button>
          <button class="btn collapse" title="Collapse card">Close</button>
        </div>
      </div>

      <div class="grid" style="margin-top:12px">
        <div class="section">
          <h3>Visitation</h3>
          <div class="kv">
            <div><label>Date/Time</label></div><div><input class="dt" data-bind="visitation.when" type="datetime-local"></div>
            <div><label>Place</label></div><div><input class="input" data-bind="visitation.where" placeholder=""></div>
            <div><label>Notes</label></div><div><input class="input" data-bind="visitation.note" placeholder=""></div>
          </div>
        </div>
        <div class="section">
          <h3>Service</h3>
          <div class="kv">
            <div><label>Date/Time</label></div><div><input class="dt" data-bind="service.when" type="datetime-local"></div>
            <div><label>Place</label></div><div><input class="input" data-bind="service.where" placeholder=""></div>
            <div><label>Type</label></div><div>
              <select class="select" data-bind="service.type">
                <option value="">â€”</option>
                <option>Traditional</option>
                <option>Cremation</option>
                <option>Graveside</option>
                <option>FSC</option>
              </select>
            </div>
            <div><label>Notes</label></div><div><input class="input" data-bind="service.note" placeholder=""></div>
          </div>
        </div>
        <div class="section">
          <h3>Logistics</h3>
          <div class="kv">
            <div><label>Cemetery</label></div><div><input class="input" data-bind="cemetery" placeholder=""></div>
            <div><label>Vault</label></div><div><input class="input" data-bind="vault" placeholder=""></div>
            <div><label>Hearse</label></div><div><input class="input" data-bind="hearse" placeholder=""></div>
            <div><label>Clergy</label></div><div><input class="input" data-bind="clergy" placeholder=""></div>
            <div><label>Casket</label></div><div><input class="input" data-bind="casket" placeholder=""></div>
          </div>
        </div>
        <div class="section">
          <h3>Status</h3>
          <ul class="checklist">
            ${tickBox('Obituary','obituary')}
            ${tickBox('Veteran Services','veteran')}
            ${tickBox('DC Created','dc_created')}
            ${tickBox('DC Signed','dc_signed')}
            ${tickBox('DC Filed','dc_filed')}
            ${tickBox('Flag Provided','flag')}
            ${tickBox('Yellow Sheet','yellow_sheet')}
            ${tickBox('Print Goods','print_goods')}
            ${tickBox('Fingerprints','fingerprints')}
            ${tickBox('Photo Taken','photo')}
          </ul>
        </div>
      </div>

      <div class="section" style="margin-top:12px">
        <h3>Notes</h3>
        <div class="kv" style="grid-template-columns: 140px 1fr">
          <div><label>Gather</label></div><div><input class="input" data-bind="gather" placeholder=""></div>
          <div><label>General Notes</label></div><div><textarea class="input" data-bind="notes" rows="3" placeholder=""></textarea></div>
        </div>
      </div>
    </div>
  `;
}

function tickBox(label, path){
  return `<li><label style="display:flex; align-items:center; gap:8px; cursor:pointer"><input type="checkbox" data-bind="${path}"/> <span>${label}</span></label></li>`;
}

function openPrintView(k){
  const w = window.open('', '_blank');
  const styles = document.querySelector('style').outerHTML;
  w.document.write(`<!doctype html><html><head><meta charset="utf-8"><title>${k.decedent_name||'Case'}</title>${styles}</head><body>`);
  w.document.write(`<main style="max-width:740px;margin:0 auto;padding:16px">`);
  w.document.write(`<section class="card expanded" style="box-shadow:none">${cardHtmlForPrint(k)}</section>`);
  w.document.write(`</main></body></html>`);
  w.document.close(); w.focus(); w.print();
}

function cardHtmlForPrint(k){
  function fmtDT(iso){ if(!iso) return 'â€”'; const d=new Date(iso); return d.toLocaleString(); }
  return `
    <div class="row" style="flex-wrap:wrap; gap:8px 12px">
      <div>
        <div style="font-size:22px;font-weight:800">${k.decedent_name||''}</div>
        <div class="subline">Case # ${k.case_no||''} Â· ${k.location||''} Â· FDIC ${k.fdic||''}</div>
      </div>
    </div>
    <div class="grid" style="margin-top:12px">
      <div class="section"><h3>Visitation</h3><div class="kv"><div>Date/Time</div><div>${fmtDT(k.visitation_when)}</div><div>Place</div><div>${k.visitation_where||'â€”'}</div><div>Notes</div><div>${k.visitation_note||'â€”'}</div></div></div>
      <div class="section"><h3>Service</h3><div class="kv"><div>Date/Time</div><div>${fmtDT(k.service_when)}</div><div>Place</div><div>${k.service_where||'â€”'}</div><div>Type</div><div>${k.service_type||'â€”'}</div><div>Notes</div><div>${k.service_note||'â€”'}</div></div></div>
      <div class="section"><h3>Logistics</h3><div class="kv"><div>Cemetery</div><div>${k.cemetery||'â€”'}</div><div>Vault</div><div>${k.vault||'â€”'}</div><div>Hearse</div><div>${k.hearse||'â€”'}</div><div>Clergy</div><div>${k.clergy||'â€”'}</div><div>Casket</div><div>${k.casket||'â€”'}</div></div></div>
      <div class="section"><h3>Status</h3><ul class="checklist">${roTick('Obituary',k.obituary)}${roTick('Veteran Services',k.veteran)}${roTick('DC Created',k.dc_created)}${roTick('DC Signed',k.dc_signed)}${roTick('DC Filed',k.dc_filed)}${roTick('Flag Provided',k.flag)}${roTick('Yellow Sheet',k.yellow_sheet)}${roTick('Print Goods',k.print_goods)}${roTick('Fingerprints',k.fingerprints)}${roTick('Photo Taken',k.photo)}</ul></div>
    </div>
    <div class="section" style="margin-top:12px"><h3>Notes</h3><div class="kv" style="grid-template-columns: 140px 1fr"><div>Gather</div><div>${k.gather||'â€”'}</div><div>General Notes</div><div>${k.notes||''}</div></div></div>
  `;
}
function roTick(label, done){ return `<li><span class="tick ${done?'done':''}">${done?'âœ“':''}</span> <span>${label}</span></li>`; }

function openNewCaseForm(){
  const name = prompt('Decedent Name'); if (!name) return;
  const caseNo = prompt('Case #')||'';
  const fdic = prompt('FDIC initials')||'';
  const loc = prompt('Location (e.g., Wauseon, Archbold, GFH-S)')||'';
  sb.from('cases').insert({ decedent_name:name, case_no:caseNo, fdic:fdic, location:loc }).then(()=>{ renderApp(); });
}
</script>
</body>
</html>
